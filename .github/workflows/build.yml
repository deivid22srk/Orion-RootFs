name: Build Orion RootFS

on:
  push:
    branches: [ main ]
    paths:
      - 'sources/**'
      - 'scripts/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl zstd tar
    
    - name: ðŸ“¦ Download external assets
      run: |
        chmod +x scripts/download.sh
        bash scripts/download.sh
      
    - name: ðŸ”¨ Compile RootFS package
      run: |
        chmod +x scripts/compile.sh
        bash scripts/compile.sh
    
    - name: âœ… Verify package integrity
      run: |
        chmod +x scripts/verify.sh
        bash scripts/verify.sh
    
    - name: ðŸ“Š Package information
      run: |
        echo "## Build Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** $(cat sources/metadata.json | grep -oP '(?<="version": ")[^"]*')" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "- **Package Size:** $(du -h output/*.orfs | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -lh output/ >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: orion-rootfs
        path: |
          output/*.orfs
          output/*.sha256
        retention-days: 30
    
    - name: ðŸš€ Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          output/*.orfs
          output/*.sha256
        body: |
          ## Orion RootFS Release
          
          ### What's included:
          - ImageFS v21 (Linux system base)
          - Proton 9.0 ARM64EC (Wine/Proton)
          - Turnip 25.1.0 (Vulkan drivers)
          - DXVK 2.6.2-1-arm64ec-gplasync
          - VKD3D, Box64, FEXCore
          - Optimized presets for God of War
          
          ### Installation:
          1. Download `orion-rootfs-v${{ github.ref_name }}.orfs`
          2. Open GoWLauncher app
          3. Tap "Import RootFS"
          4. Select downloaded file
          5. Wait for installation (~3-5 minutes)
          
          ### Requirements:
          - Android 8.0+ (API 26+)
          - ARM64-v8a device
          - 5GB free storage
          - 4GB+ RAM recommended
          
          ### Checksums:
          Verify integrity with provided `.sha256` file
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
